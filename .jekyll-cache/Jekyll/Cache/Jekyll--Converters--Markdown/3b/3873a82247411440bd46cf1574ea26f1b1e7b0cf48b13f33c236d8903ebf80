I"¸?<h1 id="afurlsessionmanageré˜…è¯»">AFURLSessionManageré˜…è¯»</h1>

<p>æœ¬ç¬”è®°ä¸ºscfhaoé˜…è¯»AFNetworking-AFURLSessionManagerç±»æºä»£ç æ—¶è®°å½•ï¼Œå½“å‰AFNetworkingç‰ˆæœ¬3.0.4ï¼Œç¬”è®°åˆ›å»ºæ—¶é—´ï¼š2016-6-14ã€‚è¿™ç¯‡ç¬”è®°ä¸­ï¼Œç”¨â€œå…¶â€ä»£è¡¨AFURLSessionManagerç±»ã€‚ä¸ºæ–¹ä¾¿ç¨åé˜…è¯»ï¼Œæœ¬ç¯‡ç¬”è®°çš„è®°å½•é¡ºåºå°½é‡é€‰æ‹©æ›´å®¹æ˜“ç†è§£çš„é¡ºåºï¼Œå°½é‡ä¸å¤šè´´ä»£ç ã€‚</p>

<h2 id="afurlsessionmanagertaskdelegate">AFURLSessionManagerTaskDelegate</h2>

<p>AFURLSessionManagerä¸ºå…¶ä¸­æ¯ä¸ªè¯·æ±‚ä»»åŠ¡éƒ½åˆ›å»ºäº†ä¸€ä¸ªä»»åŠ¡ä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™äº›ä»£ç†å¯¹è±¡å¯ä»¥ç®¡ç†å…¶å¯¹åº”çš„ä»»åŠ¡çš„è¯·æ±‚è¿›åº¦ï¼Œå¦‚ä¸Šä¼ ä»»åŠ¡çš„ä¸Šä¼ è¿›åº¦ã€ä¸‹è½½ä»»åŠ¡çš„ä¸‹è½½è¿›åº¦ï¼Œè¿˜å®ç°äº†å‡ ä¸ªè¯·æ±‚ä»»åŠ¡ä»£ç†æ–¹æ³•ï¼ˆNSURLSessionDelegateï¼‰ã€‚è¿™ä¸ªç±»è®¾è®¡çš„å¾ˆå°å·§ã€ç²¾å¦™ï¼Œè¿™ä¸ªç±»ä½¿AFURLSessionManagerå¯¹ä¸Šä¼ ã€ä¸‹è½½è¿›åº¦çš„ç›‘æ§æ›´çµæ´»ã€‚å…¶å±æ€§åˆ—è¡¨å¦‚ä¸‹ï¼š</p>

<ul>
  <li>manager å¯¹æ‰€å±AFURLSessionManagerçš„ä¸€ä¸ªå¼±å¼•ç”¨ã€‚</li>
  <li>mutableData å­˜å‚¨å¯¹åº”è¯·æ±‚çš„å“åº”æ•°æ®ã€‚</li>
  <li>uploadProgress ä¸Šä¼ è¿›åº¦ï¼ŒNSProgresså¯¹è±¡ã€‚</li>
  <li>downloadProgress ä¸‹è½½è¿›åº¦ï¼Œä¹Ÿæ˜¯NSProgresså¯¹è±¡ã€‚</li>
  <li>downloadFileURL ä¸‹è½½æ–‡ä»¶çš„ç›®æ ‡ä½ç½®ã€‚</li>
  <li>downloadTaskDidFinishDownloading ä¸‹è½½è¯·æ±‚ä¸‹è½½å®Œæˆçš„å›è°ƒã€‚</li>
  <li>uploadProgressBlock ä¸Šä¼ å›è°ƒï¼Œä¸Šä¼ è¿›åº¦æ”¹å˜æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒã€‚</li>
  <li>downloadProgressBlock ä¸‹è½½å›è°ƒï¼Œä¸‹è½½è¿›åº¦æ”¹å˜æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒã€‚</li>
  <li>completionHandle è¯·æ±‚å®Œæˆå›è°ƒã€‚</li>
</ul>

<p>ä»ä¸Šè¿°çš„å±æ€§åˆ—è¡¨ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸ªç±»çš„ä½œç”¨ï¼Œè¿™ä¸ªç±»çš„åˆå§‹åŒ–æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ›å»ºäº†è¯·æ±‚çš„ä¸Šä¼ ä¸‹è½½è¿›åº¦å¯¹è±¡ã€‚</p>

<p>è¿™ä¸ªçš„æ–¹æ³•ä¸å¤šï¼Œé¦–å…ˆæ˜¯ç›‘æ§è¿›åº¦çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¸€ä¸ªæ˜¯ä¸ºå’Œè¿›åº¦ç›¸å…³çš„å¯¹è±¡æ·»åŠ è§‚å¯Ÿè€…ï¼Œå¦ä¸€ä¸ªç§»é™¤ä¸Šä¸ªæ–¹æ³•æ·»åŠ çš„è§‚å¯Ÿè€…ï¼Œè¿™æ˜¯iOSå¼€å‘æ¯”è¾ƒå¸¸ç”¨çš„KVOï¼Œæ‰€ä»¥ä¸è¦å†è¯´ä¸€èˆ¬çš„å¼€å‘ä¸­ç”¨ä¸åˆ°KVOäº†ï¼Œä½ æ²¡ç”¨åˆ°åªæ˜¯è¯´æ˜ä½ è‡ªå·±æœ‰å¾…æå‡ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">- setupProgressForTask:</code>å…ˆå¯¹ä¸Šä¼ ä¸‹è½½è¿›åº¦å¯¹è±¡è¿›è¡Œäº†ä¸€äº›å¸¸è§„çš„è®¾ç½®ï¼Œæ¯”å¦‚æ€»è¿›åº¦ã€å–æ¶ˆå¤„ç†ã€æš‚åœå¤„ç†ã€æ¢å¤å¤„ç†ï¼Œè®¾ç½®å®Œè¿™äº›ä»¥åï¼Œç”¨æˆ·å°±å¯ä»¥é€šè¿‡è°ƒç”¨è¿›åº¦å¯¹è±¡ï¼ˆNSProgressï¼‰çš„cancelã€pauseã€resumeæ–¹æ³•æ¥ä½¿è¯·æ±‚ä»»åŠ¡å¯¹è±¡ï¼ˆNSURLSessionTaskï¼‰åšå‡ºç›¸åº”çš„å¤„ç†äº†ã€‚ç„¶åå¯¹è¯·æ±‚ä»»åŠ¡å’Œè¿›åº¦ç›¸å…³çš„å±æ€§ï¼ˆcountOfBytesReceivedã€countOfBytesExpectedToReceiveã€countOfBytesSentã€countOfBytesExpectedToSendï¼‰å’Œè¿›åº¦å¯¹è±¡çš„è¿›åº¦ï¼ˆfractionCompletedï¼‰æ·»åŠ äº†è§‚å¯Ÿè€…ï¼Œè§‚å¯Ÿè¯·æ±‚ä»»åŠ¡å’Œè¿›åº¦ç›¸å…³çš„å±æ€§æ˜¯ä¸ºäº†æ›´æ–°NSProgresså¯¹è±¡ï¼Œè€Œè§‚å¯ŸNSProgresså¯¹è±¡çš„fractionCompletedåˆ™æ˜¯ä¸ºäº†è°ƒç”¨è¿›åº¦å›è°ƒæ–¹æ³•ã€‚</li>
  <li><code class="highlighter-rouge">- cleanUpProgressForTask:</code>è¯·æ±‚ä»»åŠ¡ç»“æŸåé€šè¿‡è°ƒç”¨æ­¤æ–¹æ³•æ¸…é™¤ä¸Šé¢æ·»åŠ çš„è§‚å¯Ÿè€…ã€‚</li>
</ul>

<p>é™¤äº†è¿›åº¦ç›‘æ§å¤–ï¼Œä»»åŠ¡ä»£ç†ç±»è¿˜åˆ†åˆ«å®ç°äº†NSURLSessionTaskDelegateã€NSURLSessionDataTaskDelegateã€NSURLSessionDownloadTaskDelegateåè®®çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">- URLSession:task:didCompleteWithError:</code>ç”¨responseSerializerå¤„ç†è¿”å›æ•°æ®ï¼Œè°ƒç”¨completionHandleå›è°ƒï¼Œå‘é€AFNetworkingTaskDidCompleteNotificationé€šçŸ¥ã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:dataTask:didReceiveData:</code>å°†æ¥æ”¶åˆ°çš„æ•°æ®æ·»åŠ åˆ°mutableDataå±æ€§ä¸­ã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:downloadTask:didFinishDownloadingToURL:</code>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨äº†è¯¥ç±»çš„downloadTaskDidFinishDownloadingå›è°ƒï¼Œç„¶åå°†ä¸‹è½½åˆ°çš„æ–‡ä»¶ç§»åŠ¨åˆ°ç›®æ ‡ä¸‹è½½ä½ç½®ï¼Œä¸Šè¿°å›è°ƒçš„è¿”å›å€¼å°±æ˜¯ç›®æ ‡ä¸‹è½½ä½ç½®ï¼Œå¦‚æœç§»åŠ¨æ–‡ä»¶å¤±è´¥ï¼Œå‘é€äº†AFURLSessionDownloadTaskDidFailToMoveFileNotificationé€šçŸ¥ã€‚</li>
</ul>

<h2 id="afurlsessionmanager">AFURLSessionManager</h2>

<h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h3>

<p>å…¶æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ä¸ºï¼š<code class="highlighter-rouge">- initWithSessionConfiguration:</code>ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œå…¶åˆå§‹åŒ–äº†è‡ªèº«çš„ä¸€äº›å±æ€§ã€‚åˆå§‹åŒ–çš„å±æ€§åˆ—è¡¨ï¼š</p>

<ul>
  <li>sessionConfiguration åˆå§‹åŒ–ä¸ºæœ¬æ–¹æ³•çš„å‚æ•°ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œåˆ™åˆå§‹åŒ–ä¸ºNSURLSessionConfiguration.defaultSessionConfigurationã€‚</li>
  <li>session ä½¿ç”¨sessionConfigurationåˆå§‹åŒ–çš„NSURLSessionï¼Œç”¨äºåˆ›å»ºè¯·æ±‚ä»»åŠ¡NSURLSessionTaskã€‚</li>
  <li>operationQueue ä¸ºä¸Šè¿°sessionå±æ€§çš„delegateQueueã€‚è¿™ä¸ªOperationQueueçš„maxConcurrentOperationCountè¢«è®¾ç½®ä¸º1ï¼Œä¿è¯NSURLSessionçš„ä»£ç†æ–¹æ³•ä¸ä¼šåŒæ—¶æ‰§è¡Œã€‚</li>
  <li>responseSerializer è¢«åˆå§‹åŒ–ä¸ºAFJSONResponseSerializerå¯¹è±¡ã€‚</li>
  <li>securityPolicy è¢«åˆå§‹åŒ–ä¸ºAFSecurityPolicy.defaultPolicyï¼Œæœ¬ç±»ä¸­æœ‰å…³å®‰å…¨ç­–ç•¥çš„å†…å®¹å°†åœ¨AFSecurityPolicyç±»çš„é˜…è¯»ç¬”è®°ä¸­æ³¨é‡Šã€‚</li>
  <li>reachabilityManager è¢«åˆå§‹åŒ–ä¸ºAFNetworkReachabilityManager.sharedManagerã€‚è¿™ä¸ªå±æ€§åœ¨æœ¬ç±»ä¸­å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ã€‚</li>
  <li>mutableTaskDelegatesKeyedByTaskIdentifier è¿™æ˜¯ä¸€ä¸ªNSMutableDictionaryç±»å‹çš„å±æ€§ï¼Œç”¨æ¥ä¿å­˜è¯·æ±‚ä»»åŠ¡ï¼ˆNSURLSessionTaskï¼‰åˆ°ä»»åŠ¡ä»£ç†å¯¹è±¡ï¼ˆAFURLSessionManagerTaskDelegateï¼‰çš„æ˜ å°„å…³ç³»ã€‚</li>
  <li>lock çº¿ç¨‹é”NSLockç±»å‹ã€‚</li>
</ul>

<p>åˆå§‹åŒ–å®Œä¸Šè¿°å±æ€§åï¼Œè°ƒç”¨äº†sessionå±æ€§çš„getTasksWithCompletionHandle:æ–¹æ³•ï¼Œä¸ºå·²å­˜åœ¨çš„taskè®¾ç½®äº†ä»»åŠ¡ä»£ç†ï¼Œè¿™é‡Œæˆ‘æœ‰ç‚¹<strong>ç–‘æƒ‘</strong>ï¼Œåˆšåˆ›å»ºçš„sessionï¼Œè¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•taskï¼Œèƒ½è·å–åˆ°taskå—ï¼Ÿ</p>

<h3 id="åˆ›å»ºè¯·æ±‚ä»»åŠ¡">åˆ›å»ºè¯·æ±‚ä»»åŠ¡</h3>

<p>è¿™é‡Œçš„è¯·æ±‚ä»»åŠ¡æŒ‡NSURLSessionTaskåŠå…¶å­ç±»ï¼ˆNSURLSessionDataTaskã€NSURLSessionUploadTaskã€NSURLSessionDownloadTaskï¼‰ã€‚åˆå§‹åŒ–äº†AFURLSessionManagerå¯¹è±¡åï¼Œå°±å¯ä»¥è°ƒç”¨å…¶åˆ›å»ºè¯·æ±‚ä»»åŠ¡çš„æ–¹æ³•äº†ï¼Œè¯·æ±‚ä»»åŠ¡çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">- dataTaskWithRequest:completionHandle:</code></li>
  <li><code class="highlighter-rouge">- dataTaskWithRequest:uploadProgress:downloadProgress:completionHandle:</code></li>
</ul>

<hr />

<ul>
  <li><code class="highlighter-rouge">- uploadTaskWithRequest:fromFile:progress:completionHandle:</code></li>
  <li><code class="highlighter-rouge">- uploadTaskWithRequest:fromData:progress:completionHandle:</code></li>
  <li><code class="highlighter-rouge">- uploadTaskWithStreamedRequest:progress:completionHandle:</code></li>
</ul>

<hr />

<ul>
  <li><code class="highlighter-rouge">- downloadTaskWithRequest:progress:destination:completionHandle:</code></li>
  <li><code class="highlighter-rouge">- downloadTaskWithResumeData:progress:destination:completionHandle:</code></li>
</ul>

<h3 id="ä¸ºè¯·æ±‚å¯¹è±¡è®¾ç½®ä»£ç†">ä¸ºè¯·æ±‚å¯¹è±¡è®¾ç½®ä»£ç†</h3>

<p>ä¸Šè¿°åˆ›å»ºè¯·æ±‚ä»»åŠ¡çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå…ˆè°ƒç”¨NSURLSessionç±»çš„å¯¹åº”æ–¹æ³•åˆ›å»ºäº†taskï¼Œç„¶ååˆ†åˆ«ä¸ºä¸åŒç±»å‹çš„taskå¯¹è±¡è°ƒç”¨å¯¹åº”çš„è®¾ç½®ä»»åŠ¡ä»£ç†çš„æ–¹æ³•è®¾ç½®äº†å‰é¢è¯´çš„ä»»åŠ¡ä»£ç†ï¼ˆAFURLSessionManagerTaskDelegateï¼‰ï¼Œè¿™äº›è®¾ç½®ä»»åŠ¡ä»£ç†çš„ç›¸å…³æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">- addDelegateForDataTask:uploadProgress:downloadProgress:completionHandle:</code></li>
  <li><code class="highlighter-rouge">- addDelegateForUploadTask:progress:completionHandle:</code></li>
  <li><code class="highlighter-rouge">- addDelegateForDownloadTask:progress:destination:completionHandle</code></li>
</ul>

<p>ä¸Šé¢3ä¸ªæ–¹æ³•ä¸­åˆ†åˆ«ä¸º3ç§ä¸åŒç±»å‹çš„è¯·æ±‚ä»»åŠ¡åˆ›å»ºäº†è¯·æ±‚ä»£ç†å¯¹è±¡ï¼Œè®¾ç½®å¥½ä»£ç†å¯¹è±¡çš„å±æ€§ã€‚</p>

<h3 id="è¯·æ±‚ä»»åŠ¡ä»£ç†å¯¹è±¡çš„å­˜å–">è¯·æ±‚ä»»åŠ¡ä»£ç†å¯¹è±¡çš„å­˜å–</h3>

<p>åœ¨ä¸ºè¯·æ±‚ä»»åŠ¡åˆ›å»ºå¥½ä»»åŠ¡ä»£ç†å¯¹è±¡åï¼Œè¿™äº›å¯¹è±¡å­˜åˆ°äº†AFURLSessionManagerç±»çš„mutableTaskDelegatesKeyedByTaskIdentifierå­—å…¸ä¸­ï¼Œè¿™ä¸ªå­—å…¸ä¸­taskçš„identifierä¸ºkeyï¼Œä»»åŠ¡ä»£ç†å¯¹è±¡ä¸ºvalueï¼Œå­˜å–è¿™ä¸ªå­—å…¸æ—¶ï¼Œä½¿ç”¨äº†çº¿ç¨‹é”ä¿è¯åœ¨å¤šä¸ªçº¿ç¨‹ä¸­è®¿é—®è¿™ä¸ªå­—å…¸çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚ç›¸å…³æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">setDelegate:forTask:</code>å°†ä»£ç†å¯¹è±¡å­˜å…¥å­—å…¸ï¼Œè°ƒç”¨ä»£ç†æ–¹æ³•çš„<code class="highlighter-rouge">setupProgressForTask:</code>æ–¹æ³•ï¼Œæ³¨å†Œç›‘å¬taskçš„æŒ‚èµ·ã€æ¢å¤é€šçŸ¥ã€‚</li>
  <li><code class="highlighter-rouge">delegateForTask:</code>ä»å­—å…¸ä¸­å–åˆ°ä»£ç†å¯¹è±¡å¹¶è¿”å›ã€‚</li>
  <li><code class="highlighter-rouge">removeDelegateForTask:</code>ä»å­—å…¸ä¸­ç§»é™¤ä»£ç†å¯¹è±¡ï¼Œç§»é™¤<code class="highlighter-rouge">setDelegate:forTask:</code>æ–¹æ³•ä¸­æ³¨å†Œçš„é€šçŸ¥ã€‚</li>
</ul>

<h3 id="è¯·æ±‚çš„æŒ‚èµ·ä¸æ¢å¤">è¯·æ±‚çš„æŒ‚èµ·ä¸æ¢å¤</h3>

<p>AFNetworkingé€šè¿‡<em>method swizzle</em>åœ¨NSURLSessionTaskç±»çš„resumeå’Œsuspendæ–¹æ³•ä¸­åˆ†åˆ«å‘é€äº†AFNSURLSessionTaskDidResumeNotificationå’ŒAFNSURLSessionTaskDidSuspendNotificationé€šçŸ¥ã€‚</p>

<p>AFURLSessionManageråœ¨æ”¶åˆ°å¯¹åº”çš„é€šçŸ¥åï¼Œåˆ¤æ–­é€šçŸ¥å¯¹åº”çš„taskå¦‚æœæ˜¯è‡ªå·±ï¼ˆæŒ‡AFURLSessionManagerå¯¹è±¡ï¼‰åˆ›å»ºçš„taskï¼Œåˆ™ç»§ç»­åˆ†å‘äº†AFNetworkingTaskDidResumeNotificationå’ŒAFNetworkingTaskDidSuspendNotificationé€šçŸ¥ï¼Œè§<code class="highlighter-rouge">taskDidResume:</code>å’Œ<code class="highlighter-rouge">taskDidSuspend:</code>ä¸¤ä¸ªæ–¹æ³•ã€‚</p>

<h3 id="åŒæ­¥åœ°è°ƒç”¨å¼‚æ­¥æ–¹æ³•">åŒæ­¥åœ°è°ƒç”¨å¼‚æ­¥æ–¹æ³•</h3>

<p>è¿™ä¸ªç±»ä¸­å°è£…äº†å‡ ä¸ªæ–¹ä¾¿è°ƒç”¨æ–¹è·å–å½“å‰AFURLSessionManagerä¸­çš„è¯·æ±‚ä»»åŠ¡æ•°ç»„çš„æ–¹æ³•ï¼Œä¸ºï¼š<code class="highlighter-rouge">tasks</code>ã€<code class="highlighter-rouge">dataTasks</code>ã€<code class="highlighter-rouge">uploadTasks</code>ã€<code class="highlighter-rouge">downloadTasks</code>ï¼Œè¿™å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯é€šè¿‡è°ƒç”¨<code class="highlighter-rouge">tasksForKeyPath:</code>æ–¹æ³•è·å–å¯¹åº”çš„æ•°ç»„ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨sessionå¯¹è±¡çš„å¼‚æ­¥æ–¹æ³•<code class="highlighter-rouge">getTasksWithCompletionHandle:</code>è·å–sessionä¸‹çš„è¯·æ±‚ä»»åŠ¡ï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œå¤–å±‚æ–¹æ³•è¿”å›æ—¶å†…å±‚çš„å¼‚æ­¥æ–¹æ³•è¿˜æœªæ‰§è¡Œç»“æŸï¼Œæ­¤æ—¶è¿”å›å€¼æ˜¯nilï¼ŒAFURLSessionManageré€šè¿‡ä½¿ç”¨GCDæä¾›çš„ä¿¡å·é‡ï¼Œè¾¾åˆ°äº†åŒæ­¥åœ°è·å–å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼çš„æ•ˆæœï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (NSArray *)tasksForKeyPath:(NSString *)keyPath {
    __block NSArray *tasks = nil;
    // åˆ›å»ºäº†åˆå§‹ä¿¡å·ä¸º0çš„ä¿¡å·é‡
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
    // ä¸‹é¢æ–¹æ³•å‚æ•°ä¸­çš„blockä¼šå¼‚æ­¥æ‰§è¡Œå³ä¸åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œ
    [self.session getTasksWithCompletionHandler:^(NSArray *dataTasks, NSArray *uploadTasks, NSArray *downloadTasks) {
        // ...
		// å¼‚æ­¥çš„blockæ‰§è¡Œç»“æŸï¼Œå‘é€ä¸€ä¸ªä¿¡å·
        dispatch_semaphore_signal(semaphore);
    }];
	// å½“å‰çº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œå› ä¸ºä¿¡å·é‡çš„åˆå§‹ä¿¡å·æ•°æ˜¯0ï¼Œæ‰€ä»¥çº¿ç¨‹åœ¨è¿™é‡Œä¼šé˜»å¡ï¼Œç›´åˆ°æ¥æ”¶åˆ°ä¸Šé¢çš„blockåœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œç»“æŸåå‘é€çš„ä¿¡å·ï¼Œè¿™é‡Œæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);

    return tasks;
}
</code></pre></div></div>

<h3 id="é”€æ¯session">é”€æ¯session</h3>
<p>è°ƒç”¨AFURLSessionManagerå¯¹è±¡çš„<code class="highlighter-rouge">invalidateSessionCancelingTasks:</code>æ–¹æ³•å¯ä»¥ä½¿sessionå¤±æ•ˆï¼Œå¦‚æœæ”¹æ–¹æ³•çš„å‚æ•°ä¸ºYESï¼Œä¼šåŒæ—¶å–æ¶ˆæœªå®Œæˆçš„è¯·æ±‚ä»»åŠ¡ã€‚</p>

<h3 id="å›è°ƒ">å›è°ƒ</h3>
<p>AFURLSessionManagerå®ç°äº†NSURLSessionçš„ä»£ç†æ–¹æ³•ï¼Œä¸ºäº†è®©ç”¨æˆ·æ–¹ä¾¿å¾—å®šåˆ¶è¿™äº›ä»£ç†æ–¹æ³•çš„å®ç°ï¼ŒAFURLSessionManageræä¾›äº†ä¸€æ‰¹å›è°ƒå±æ€§ã€‚æœ‰ç‚¹å¤šï¼Œä¸è¿‡è¿™ä¸ªç±»é©¬ä¸Šå°±çœ‹å®Œäº†ï¼Œå†å¿ä¸€ä¸‹ã€‚</p>

<ul>
  <li>sessionDidBecomeInvalid</li>
  <li>sessionDidReceiveAuthenticationChallenge</li>
  <li>didFinishEventsForBackgroundURLSession</li>
</ul>

<hr />
<ul>
  <li>taskNeedNewBodyStream</li>
  <li>taskWillPerformHTTPRedirection</li>
  <li>taskDidReceiveAuthenticationChallenge</li>
  <li>taskDidSendBodyData</li>
  <li>taskDidComplete</li>
</ul>

<hr />
<ul>
  <li>dataTaskDidReceiveResponse</li>
  <li>dataTaskDidBecomeDownloadTask</li>
  <li>dataTaskDidReceiveData</li>
  <li>dataTaskWillCacheResponse</li>
</ul>

<hr />
<ul>
  <li>downloadTaskDidFinishDownloading</li>
  <li>downloadTaskDidWriteData</li>
  <li>downloadTaskDidResume</li>
</ul>

<h3 id="session-ä»£ç†æ–¹æ³•å®ç°">Session ä»£ç†æ–¹æ³•å®ç°</h3>

<p>AFURLSessionManageræœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯å®ç°å…¶sessionå±æ€§çš„ä¼—å¤šä»£ç†æ–¹æ³•ï¼ŒåŒ…æ‹¬NSURLSessionDelegateã€NSURLSessionTaskDelegateã€NSURLSessionDataTaskDelegateã€NSURLDownloadTaskDelegateåè®®çš„æ–¹æ³•ã€‚è™½ç„¶æœ‰ç‚¹å¤šï¼Œä½†è¿™äº›æ–¹æ³•çš„å®ç°å¯å¦‚ä¸‹åˆ†ç±»ï¼š</p>

<h4 id="ä»…è°ƒç”¨å¤–éƒ¨ä¼ è¿›æ¥çš„å›è°ƒ">ä»…è°ƒç”¨å¤–éƒ¨ä¼ è¿›æ¥çš„å›è°ƒ</h4>
<p>åœ¨è¿™äº›æ–¹æ³•ä¸­ä»…ä»…æ˜¯è°ƒç”¨å¤–éƒ¨è®¾ç½®çš„å¯¹åº”çš„å›è°ƒï¼Œæˆ–è¿›è¡Œäº†å°‘è®¸å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å›è°ƒï¼Œä»€ä¹ˆéƒ½ä¸ä¼šæ‰§è¡Œï¼Œç”šè‡³é‡å†™äº†<code class="highlighter-rouge">respondsToSelector:</code>ï¼Œå¯¹æ²¡æœ‰è®¾ç½®å¯¹åº”çš„å›è°ƒçš„ä»£ç†æ–¹æ³•è¿”å›NOã€‚è¿™æ ·çš„æ–¹æ³•æœ‰ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">- URLSession:didBecomeInvalidWithError</code>è°ƒç”¨å›è°ƒå¤–ï¼Œè¿˜å‘é€äº†AFURLSessionDidInvalidateNotificationé€šçŸ¥ã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:task:willPerformHTTPRedirection:newRequest:completionHandle:</code>ä»…è°ƒç”¨å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:task:didSendBodyData:totalBytesSent:totalBytesExpectedToSend:</code>å…ˆå¯¹totalUnitCountä¸ºNSURLSessionTransferSizeUnknownçš„æƒ…å†µåšäº†å®¹é”™ï¼Œç„¶åè°ƒç”¨äº†å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:task:needNewBodyStream:</code>å¦‚æœæœªè®¾ç½®å›è°ƒï¼Œä½¿ç”¨åŸå§‹è¯·æ±‚çš„çš„HTTPBodyStreamã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:dataTask:didReceiveResponse:completionHandle:</code>ä»…è°ƒç”¨å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:dataTask:didBecomeDownloadTask:</code>ä¸ºtaské‡æ–°è®¾ç½®äº†ä¸€ä¸ªä»»åŠ¡ä»£ç†ï¼Œç„¶åè°ƒç”¨å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:downloadTask:didResumeAtOffset:expectedTotalBytes:</code>ä»…è°ƒç”¨å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesExpectedToWrite:</code>è¿™é‡Œä»…ä»…æ˜¯è°ƒç”¨äº†å›è°ƒï¼ŒAFURLSessionManagerå¹¶æœªåˆ©ç”¨è¯¥æ–¹æ³•è®¡ç®—ä¸‹è½½ä»»åŠ¡çš„ä¸‹è½½è¿›åº¦ï¼Œè€Œæ˜¯é€šè¿‡KVOè§‚å¯Ÿäº†ä¸‹è½½ä»»åŠ¡çš„ç›¸å…³å±æ€§æ¥è®¡ç®—çš„è¿›åº¦ã€‚</li>
  <li><code class="highlighter-rouge">- URLSessionDidFinishEventsForBackgroundURLSession:</code>åœ¨ä¸»çº¿ç¨‹è°ƒç”¨å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:dataTask:willCacheResponse:completionHandle:</code>ä»…è°ƒç”¨å›è°ƒã€‚</li>
</ul>

<h4 id="è½¬å‘ç»™è¯·æ±‚ä»»åŠ¡ä»£ç†å¯¹è±¡æ‰§è¡Œ">è½¬å‘ç»™è¯·æ±‚ä»»åŠ¡ä»£ç†å¯¹è±¡æ‰§è¡Œ</h4>
<p>ä»»åŠ¡ä»£ç†å¯¹è±¡å®ç°äº†3ä¸ªä»£ç†æ–¹æ³•ï¼Œè¿™3ä¸ªä»£ç†æ–¹æ³•é™¤äº†è‡ªå·±æ‰§è¡Œä¸€äº›æ“ä½œï¼Œè°ƒç”¨å›è°ƒå¤–è¿˜è°ƒç”¨äº†ä»»åŠ¡ä»£ç†å¯¹è±¡å¯¹åº”çš„æ–¹æ³•ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">- URLSession:task:didCompleteWithError:</code>å…ˆè°ƒç”¨äº†ä»»åŠ¡ä»£ç†å¯¹è±¡å¯¹åº”çš„æ–¹æ³•ï¼Œç„¶åè°ƒç”¨è‡ªèº«çš„removeDelegateForTaskæ–¹æ³•æ¸…ç†äº†ä»£ç†å¯¹è±¡ï¼Œæœ€åè°ƒç”¨äº†å¤–éƒ¨è®¾ç½®çš„å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:dataTask:didReceiveData:</code>å…ˆè°ƒç”¨äº†ä»»åŠ¡ä»£ç†å¯¹è±¡çš„å¯¹åº”æ–¹æ³•ï¼Œç„¶åè°ƒç”¨äº†å¤–éƒ¨è®¾ç½®çš„å›è°ƒã€‚</li>
  <li><code class="highlighter-rouge">- URLSession:downloadTask:didFinishDownloadingToURL:</code>å…ˆè°ƒç”¨å›è°ƒæ–¹æ³•å¾—åˆ°ä¸‹è½½ä»»åŠ¡çš„ç›®æ ‡ä½ç½®ï¼Œå°†ä¸‹è½½å®Œæˆçš„æ–‡ä»¶ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®ï¼Œåè°ƒç”¨ä»»åŠ¡ä»£ç†å¯¹è±¡çš„å¯¹åº”æ–¹æ³•ã€‚ä»»åŠ¡ä»£ç†å®ç°çš„è¿™ä¸ªæ–¹æ³•ä¸­ä¹Ÿæœ‰ç§»åŠ¨æ–‡ä»¶çš„æ“ä½œï¼Œæ‰€ä»¥å¦‚æœåŒæ—¶è®¾ç½®äº†AFURLSessionManagerçš„downloadTaskDidFinishDownloadingå›è°ƒå¹¶åœ¨åˆ›å»ºä¸‹è½½ä»»åŠ¡æ—¶ä¼ å…¥äº†destinationå›è°ƒæ—¶ï¼Œä¸‹è½½å®Œæˆåï¼Œä»»åŠ¡ä»£ç†å¯¹è±¡çš„ç§»åŠ¨æ–‡ä»¶çš„æ“ä½œå°†ä¼šå¤±è´¥ã€‚</li>
</ul>

<h4 id="å…¶ä»–ä»£ç†æ–¹æ³•">å…¶ä»–ä»£ç†æ–¹æ³•</h4>
<p>å‰©ä½™çš„è¿™ä¸¤ä¸ªä»£ç†æ–¹æ³•å°†åœ¨AFSecurityPolicyç±»çš„é˜…è¯»ç¬”è®°ä¸­è¯´æ˜ã€‚</p>

<ul>
  <li><code class="highlighter-rouge">- URLSession:didReceiveChallenge:completionHandle:</code></li>
  <li><code class="highlighter-rouge">- URLSession:task:didReceiveChallenge:completionHandle:</code></li>
</ul>
:ET